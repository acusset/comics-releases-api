<!DOCTYPE html>
<html lang="fr">
<head>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>
    <script type="text/javascript" src="https://momentjs.com/downloads/moment-with-locales.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
    <meta charset="UTF-8">
    <title>PREVIEWSworld New Releases</title>
</head>
<body class="grey lighten-3">

<nav class="nav-extended red" style="margin-bottom: 2%;">
    <div class="nav-wrapper">
        <a href="#" class="brand-logo center">
        </a>
    </div>
    <div class="nav-content">
        <ul class="tabs tabs-transparent">
        </ul>
    </div>
</nav>

<div class="container">
    <div class="row col-md-6 col-md-offset-3">
        <div id="container" class="container">
        </div>
    </div>
</div>

<script>
    var container = $("#container");
    var nav = $("ul.tabs-transparent");
    $.get('newreleases.txt', function test(data) {
        var lines = data.split('\n');
        var slug = "";
        var dateRegex = /(0?[1-9]|[12][0-9]|3[01])[\/\-](0?[1-9]|1[012])[\/\-]\d{4}/g;
        var regex = /(^[A-Z]{3}[0-9]{6})\s(.+)\s\$(([0-9]+\.[0-9]{2})|PI)/i;
        for (var i = 0; i < lines.length; i++) {
            var line = lines[i];
            if (!line || line.length <= 1) {
                continue;
            }
            if (i == 0) { // parse and display
                var date = line.match(dateRegex)[0];
                $('a.brand-logo').text("New Releases " + moment(date).format('L'));
                continue;
            }
            var values = line.match(regex);
            if (values) {
                var el = '<li class="collection-item"><span class="badge">$' + (parseFloat(values[3]) ? parseFloat(values[3]) : 0) + '</span> ' + values[2] + '</li>';
                $('ul').last().append(el);
            } else if (i > 7) { // skip first lines
                var title = line.trim();
                slug = slugify(title);
                var tab = '<li class="tab"><a href="#' + slug + '">' + slug + '</a></li>';
                var list = '<div class="row" id="' + slug + '"><a name="' + slug + '"><ul class="collection with-header z-depth-1"></ul></a></div>';
                container.append(list);
                nav.append(tab);
            }
        }
    });

    function slugify(text) {
        return text.toString().toLowerCase()
            .replace(/\s+/g, '-')           // Replace spaces with -
            .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
            .replace(/\-\-+/g, '-')         // Replace multiple - with single -
            .replace(/^-+/, '')             // Trim - from start of text
            .replace(/-+$/, '');            // Trim - from end of text
    }
</script>
</body>
</html>